generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  clerkId             String               @unique
  email               String               @unique
  username            String               @unique
  photo               String
  firstName           String?
  lastName            String?
  stripeCustomerId    String?
  planId              Int                  @default(1)
  // User roles and permissions
  role                UserRole             @default(USER)
  isActive            Boolean              @default(true)
  // User-scoped credits (for personal accounts)
  creditBalance       Int                  @default(10)
  lowBalanceThreshold Int                  @default(5)
  autoTopUpEnabled    Boolean              @default(false)
  autoTopUpAmountCredits Int?
  creditBalanceVersion Int                  @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  ledger              CreditLedger[]
  jobQuotes           JobQuote[]
  jobs                Job[]
  organizationMembers OrganizationMember[]
  transactions        Transaction[]
  trendingImports     TrendingImportLog[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model Organization {
  id        String               @id @default(cuid())
  clerkId   String               @unique
  name      String
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  credits   CreditBalance?
  ledger    CreditLedger[]
  jobQuotes JobQuote[]
  jobs      Job[]
  members   OrganizationMember[]
  priceBook PriceBookEntry[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           String       @default("member")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model CreditBalance {
  id                  String       @id @default(cuid())
  organizationId      String       @unique
  balance             Int          @default(0)
  lowBalanceThreshold Int          @default(10)
  autoTopUpEnabled    Boolean      @default(false)
  autoTopUpAmountCredits Int?
  version             Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("credit_balances")
}

model CreditLedger {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?
  jobId          String?
  type           String
  amount         Int
  reason         String
  metadata       Json?
  idempotencyKey String?      @unique
  externalJobId  String?
  clientId       String?
  environment    String       @default("production")
  breakdown      Json?
  balanceAfter   Int?
  status         String       @default("completed")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])

  @@map("credit_ledger")
}


model PriceBookEntry {
  id                  String       @id @default(cuid())
  organizationId      String
  actionKey           String
  unitType            String
  unitStep            Int          @default(1)
  retailCostPerUnit   Int
  internalCostFormula String
  isActive            Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, actionKey])
  @@map("price_book")
}

model Job {
  id                     String       @id @default(cuid())
  organizationId         String
  userId                 String
  workflowId             String?
  status                 String       @default("pending")
  title                  String
  description            String?
  quotedCredits          Int?
  quotedAt               DateTime?
  confirmedAt            DateTime?
  startedAt              DateTime?
  completedAt            DateTime?
  failedAt               DateTime?
  totalInternalCostUsd   Float?
  totalRetailCostCredits Int?
  resultUrl              String?
  errorMessage           String?
  metadata               Json?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   User         @relation(fields: [userId], references: [id])

  @@map("jobs")
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String
  stripeId  String   @unique
  amount    Float
  plan      String?
  credits   Int?
  status    String   @default("completed")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model JobQuote {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  workflowType   String
  parameters     Json
  totalCredits   Int
  breakdown      Json
  expiresAt      DateTime
  status         String       @default("active")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@map("job_quotes")
}

model TrendingProduct {
  id               String                @id @default(cuid())
  tiktokProductId  String                @unique
  name             String
  tiktokProductUrl String
  displayImageUrl  String
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  weekStats        ProductWeekStat[]
  matches          ProductAmazonMatch[]
  videos           TrendingVideo[]

  @@map("products")
}

model WeeklyReport {
  id            String             @id @default(cuid())
  weekStartDate DateTime
  weekEndDate   DateTime
  label         String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  stats         ProductWeekStat[]
  importLogs    TrendingImportLog[]

  @@unique([weekStartDate, weekEndDate])
  @@map("weekly_reports")
}

model ProductWeekStat {
  id                 String           @id @default(cuid())
  reportId           String
  productId          String
  rankThisWeek       Int?
  tiktokSales7d      Int?
  tiktokDailySales   Int?
  amazonSales7d      Int?
  snapshotPriceCents Int?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  report             WeeklyReport     @relation(fields: [reportId], references: [id], onDelete: Cascade)
  product            TrendingProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([reportId, productId])
  @@map("product_week_stats")
}

model AmazonProduct {
  asin          String               @id
  canonicalUrl  String
  title         String?
  brand         String?
  mainImageUrl  String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  matches       ProductAmazonMatch[]

  @@map("amazon_products")
}

model ProductAmazonMatch {
  id         String          @id @default(cuid())
  productId  String
  asin       String
  confidence Float           @default(0.5)
  source     String          @default("kalodata")
  chosen     Boolean         @default(false)
  matchedAt  DateTime        @default(now())
  method     String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  product    TrendingProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  amazon     AmazonProduct   @relation(fields: [asin], references: [asin], onDelete: Cascade)

  @@unique([productId, asin])
  @@map("product_amazon_matches")
}

model TrendingVideo {
  id             String           @id @default(cuid())
  url            String           @unique
  productId      String
  rankForProduct Int?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  product        TrendingProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("videos")
}

model TrendingImportLog {
  id            String             @id @default(cuid())
  fileLabel     String
  uploaderId    String?
  status        ImportStatus       @default(PENDING)
  rowsProcessed Int                @default(0)
  rowsCreated   Int                @default(0)
  rowsUpdated   Int                @default(0)
  rowsSkipped   Int                @default(0)
  rowsFlagged   Int                @default(0)
  notes         Json?
  startedAt     DateTime           @default(now())
  completedAt   DateTime?
  reportId      String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  report        WeeklyReport?      @relation(fields: [reportId], references: [id])
  uploader      User?              @relation(fields: [uploaderId], references: [id])

  @@map("import_logs")
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
